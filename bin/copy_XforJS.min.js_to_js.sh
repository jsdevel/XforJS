#!/bin/sh
#
# Copyright 2012 Joseph Spencer.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# For more information, visit http://XforJS.com
#
# THIS SCRIPT COPIES WHATEVER THE CURRENT VERSION IS FROM THE XFORJS
# PROJECT OVER TO THE DOCS.  IT IS ASSUMED THAT THE STRUCTURE IS OF
# THE FOLLOWING:
#
#     XforJS/
#     XforJS-docs/
#
NEXT_VERSION=$(cat $DIR_XFORJS/bin/VERSION);
DOC_VERSION_FILE=$DIR_BIN/VERSION;
DOC_PREVIOUS_VERSION_FILE=$DIR_BIN/VERSION_PREVIOUS;

newPrefix=XforJS.${NEXT_VERSION};
latestBase=$DIR_XFORJS/build/javascript/$newPrefix;
newSrc=$latestBase.js;
newMin=$latestBase.min.js;
downloadDir=$DIR_PROJECT/src/assets/downloads;

if [ -f $DOC_VERSION_FILE ];then
   CURRENT_VERSION=$(cat $DOC_VERSION_FILE);
fi

if [ -f $DOC_PREVIOUS_VERSION_FILE ];then
   PREVIOUS_VERSION=$(cat $DOC_PREVIOUS_VERSION_FILE);
else
   PREVIOUS_VERSION=$NEXT_VERSION;
fi

previousChangelog=$DIR_PROJECT/src/assets/json/CHANGELOG.${PREVIOUS_VERSION}.json;

if [ "$NEXT_VERSION" != "$CURRENT_VERSION" ];then
   echo -n $NEXT_VERSION > $DOC_VERSION_FILE;
   oldfile=$DIR_PROJECT/src/assets/js/XforJS.${CURRENT_VERSION}.min.js;
   if [ -f $oldfile ];then
#remove what is used in the docs.
#this leaves what is in the download directory.
      rm $oldfile;
   fi
   echo -n $CURRENT_VERSION > $DOC_PREVIOUS_VERSION_FILE;
fi


cd $DIR_XFORJS

git --no-pager log $PREVIOUS_VERSION..$CURRENT_VERSION --format=%B > $DIR_BIN/CHANGELOG

cd $DIR_BIN


#for the docs
cp $newMin $DIR_PROJECT/src/assets/js/$newPrefix.min.js
cp $DIR_XFORJS/test/templates/raw/documentation/language_overview.xjs $DIR_PROJECT/src/assets/xjs
node $DIR_BIN/build_language_doc_view.js

#for downloads
cp $newMin $downloadDir/$newPrefix.min.js
cp $newSrc $downloadDir/$newPrefix.js


if [ -f $previousChangelog ];then
   mv $previousChangelog $downloadDir/CHANGELOG.${PREVIOUS_VERSION}.json
fi

node build_changelog.js